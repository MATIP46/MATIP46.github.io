<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Terminal</title>
<style>
html,body{margin:0;height:100%;background:#0b0b0b;font-family:monospace;overflow:hidden}
#term{height:100%;padding:14px;color:#00ff88;overflow-y:auto}
.line{white-space:pre-wrap;line-height:1.4}
.promptline{display:flex}
.prompt{margin-right:4px}
.input{flex:1;background:none;border:none;outline:none;color:inherit;font:inherit;padding:0}
.output{color:#ddd}
.error{color:#ff5555;font-weight:bold}
</style>
</head>
<body>
<div id="term"></div>
<script>
/* ================= STATE ================= */
const term=document.getElementById("term");
const vars={};
const history=[];
let hIndex=0;
let username=localStorage.getItem("username")||"user";
let lastOutput="";

/* ================= PRINT ================= */
function print(text, cls="output", target=term){
  const d=document.createElement("div");
  d.className="line "+cls;
  d.textContent=text;
  target.appendChild(d);
  term.scrollTop=term.scrollHeight;
}

/* ================= PROMPT ================= */
function prompt(){
  const row=document.createElement("div");
  row.className="line promptline";

  const p=document.createElement("span");
  p.className="prompt";
  p.textContent=`${username}@homebrew::`;

  const i=document.createElement("input");
  i.className="input";

  const outputBlock=document.createElement("div");
  outputBlock.className="output-block";

  i.onkeydown=async e=>{
    if(e.key==="Enter"){
      const v=i.value.trim();
      history.push(v);
      hIndex=history.length;
      i.disabled=true;
      await execute(v, outputBlock);
      prompt();
    }
    if(e.key==="ArrowUp"){
      hIndex=Math.max(0,hIndex-1);
      i.value=history[hIndex]||"";
      e.preventDefault();
    }
    if(e.key==="ArrowDown"){
      hIndex=Math.min(history.length,hIndex+1);
      i.value=history[hIndex]||"";
      e.preventDefault();
    }
    if(e.key==="Tab"){
      e.preventDefault();
      autocomplete(i,e.shiftKey);
    }
    if(e.ctrlKey && e.key==="l"){
      term.innerHTML="";
      prompt();
    }
  };

  row.append(p,i);
  term.append(row,outputBlock);
  i.focus();
  term.scrollTop=term.scrollHeight;
}

/* ================= AUTOCOMPLETE ================= */
function autocomplete(input,varsOnly){
  const text=input.value;
  const list=varsOnly?Object.keys(vars):Object.keys(cmds);
  const match=list.filter(c=>c.startsWith(text));
  if(match.length===1) input.value=match[0];
}

/* ================= EXECUTION ================= */
async function execute(line, block){
  lastOutput="";
  for(const part of line.split("|").map(s=>s.trim())){
    lastOutput=await run(part,lastOutput,block);
  }
}

async function run(line,input,block){
  if(!line)return "";
  const parts=line.split(/\s+/);
  const cmd=parts[0];
  const args=parts.slice(1).map(a=>{
    if(a.startsWith("$")) return vars[a.slice(1)]??"";
    return a;
  });
  if(cmds[cmd]) return await cmds[cmd](args,input,block);
  print(`command not found: ${cmd}`,"error",block);
  return "";
}

/* ================= COMMANDS ================= */
const cmds={};

cmds.help=(a,i,b)=>{
  print("Commands:", "output", b);
  Object.keys(cmds).forEach(c=>print(" "+c,"output",b));
};

cmds.clear=(a,i,b)=>term.innerHTML="";

cmds.echo=(a,i,b)=>{
  const t=a.join(" ");
  print(t,"output",b);
  return t;
};

cmds.name=(a,i,b)=>{
  if(a.length!==1){
    print(`name: expected 1 argument, got ${a.length}`,"error",b);
    return;
  }
  username=a[0];
  localStorage.setItem("username",username);
};

cmds.set=(a,i,b)=>{
  if(a.length!==1||!a[0].includes("=")){
    print("set: expected name=value","error",b);
    return;
  }
  const [k,v]=a[0].split("=");
  vars[k]=v;
};

cmds.math=(a,i,b)=>{
  try{
    const r=Function("return "+(a.join(" ")||i))();
    print(r,"output",b);
    return r;
  }catch{
    print("math error","error",b);
  }
};

cmds.advmath=(a,i,b)=>{
  try{
    const r=Function("with(Math){return "+(a.join(" ")||i)+"}")();
    print(r,"output",b);
    return r;
  }catch{
    print("advanced math error","error",b);
  }
};

cmds.url=(a,i,b)=>{
  if(a.length!==1){
    print(`url: expected 1 argument, got ${a.length}`,"error",b);
    return;
  }
  location.href=a[0];
};

cmds.urlwindow=(a,i,b)=>{
  if(a.length!==1){
    print(`urlwindow: expected 1 argument, got ${a.length}`,"error",b);
    return;
  }
  window.open(a[0],"_blank");
};

/* ================= START ================= */
prompt();
</script>
</body>
</html>
